# Rustビルドのディスク容量最適化

このドキュメントでは、jvプロジェクト用に設定されたディスク容量最適化設定について説明します。

## 設定ファイル

### Cargo.toml（ワークスペースレベル）

ワークスペースの`Cargo.toml`には最適化されたビルドプロファイルが含まれています：

- **開発プロファイル (`[profile.dev]`)**:
  - `debug = 1`: デバッグ情報を削減（デバッグオーバーヘッドを約50%削減）
  - `lto = "thin"`: 適度なビルド時間でバイナリサイズを小さくするThin LTO
  - `codegen-units = 256`: ビルド速度のためのデフォルト並列性
  - `incremental = true`: 高速リビルドのための増分コンパイルを有効化

- **リリースプロファイル (`[profile.release]`)**:
  - `debug = false`: リリースビルドではデバッグ情報なし
  - `opt-level = 3`: 最大最適化
  - `lto = "fat"`: 可能な限り小さなバイナリのためのフルLTO
  - `strip = true`: バイナリからシンボルを削除
  - `panic = "abort"`: より小さなパニック処理コード
  - `codegen-units = 1`: ビルド時間を犠牲にしてより良い最適化

- **依存関係の最適化**:
  - `[profile.dev.package."*"]`: 開発ビルドでも依存関係を最適化
  - `[profile.dev.build-override]`: ビルドスクリプトを最適化

### .cargo/config.toml

プロジェクト固有のCargo設定には以下が含まれます：

- **レジストリ設定**:
  - `protocol = "sparse"`: より高速で効率的なクレートインデックス

- **ネットワーク最適化**:
  - `git-fetch-with-cli = true`: Git依存関係にシャロークローンを使用

- **ターゲット固有の設定**:
  - `target-cpu=native`: 現在のCPUアーキテクチャに最適化

- **便利なエイリアス**:
  - `deep-clean`: すべてのビルドアーティファクトとキャッシュをクリーン
  - `lean-build`: 最小限のデバッグ情報でビルド
  - `disk-usage`: ターゲットディレクトリのディスク使用量をチェック

## ディスク容量節約技術

### 実装済みの最適化

1. **デバッグ情報の削減**:
   - 開発ビルドは完全なデバッグ情報の代わりに`debug = 1`を使用
   - リリースビルドはデバッグ情報を完全に無効化

2. **リンク時最適化（LTO）**:
   - 開発ビルドでは適度なサイズ削減のためのThin LTO
   - リリースビルドでは最大サイズ削減のためのFat LTO

3. **シンボル除去**:
   - リリースビルドは`strip = true`で自動的にシンボルを除去

4. **スパースレジストリプロトコル**:
   - より高速で小さなクレートインデックスダウンロードのためのスパースレジストリを使用

5. **ネイティブCPU最適化**:
   - ターゲットCPUアーキテクチャに最適化されたビルド

### 追加の手動最適化

1. **共有ターゲットディレクトリ**（オプション）:
   ```toml
   # .cargo/config.tomlで
   [build]
   target-dir = "../target"  # プロジェクト間でターゲットディレクトリを共有
   ```

2. **並列ジョブの削減**（低メモリシステム用）:
   ```toml
   # .cargo/config.tomlで
   [build]
   jobs = 4  # システムデフォルトから削減
   ```

3. **リリース用の増分コンパイル無効化**:
   ```bash
   CARGO_INCREMENTAL=0 cargo build --release
   ```

## 使用コマンド

### 通常の開発
```bash
# 最適化を含む通常ビルド
cargo build

# リーンビルド（設定で定義されたエイリアス）
cargo lean-build

# ビルドなしでチェック
cargo check
```

### リリースビルド
```bash
# 最適化されたリリースビルド
cargo build --release

# 増分コンパイルなしのリリースビルド（最小サイズ）
CARGO_INCREMENTAL=0 cargo build --release
```

### メンテナンス
```bash
# ビルドアーティファクトをクリーン
cargo clean

# キャッシュを含む深いクリーン（設定で定義されたエイリアス）
cargo deep-clean

# ディスク使用量をチェック（設定で定義されたエイリアス）
cargo disk-usage
```

## 期待されるディスク容量削減

- **デバッグビルド**: ターゲットディレクトリサイズの約30-50%削減
- **リリースビルド**: バイナリサイズの約60-80%削減
- **依存関係コンパイル**: 依存関係最適化により約20-30%削減
- **レジストリキャッシュ**: スパースプロトコルにより約40-60%削減

## トレードオフ

### ビルド時間 vs ディスク容量
- 開発ビルド: Thin LTOのためわずかに低速
- リリースビルド: Fat LTOと単一コードジェンユニットのため大幅に低速
- 増分ビルド: 開発では有効、リリースでは無効化を検討

### デバッグ体験 vs ディスク容量
- 開発ビルドでのデバッグ情報削減はデバッグ体験に影響する可能性
- 集中的なデバッグが必要な場合は一時的に`debug = true`の使用を検討

## ディスク使用量の監視

```bash
# ターゲットディレクトリサイズをチェック
du -sh target/

# 個別プロファイルサイズをチェック
du -sh target/debug/
du -sh target/release/

# 古いビルドアーティファクトをクリーン
cargo clean --target-dir target/
```

## 細かい調整のための環境変数

```bash
# 増分コンパイルを無効化（リリースビルド）
export CARGO_INCREMENTAL=0

# rustcメモリ使用量を削減
export RUST_BACKTRACE=0

# 並列ジョブを制御
export CARGO_BUILD_JOBS=4
```