# Tasks Document

- [x] 1. 暗黙Sequenceチェーン解析を導入
  - Files: 
    - `jv/crates/jv_ir/src/sequence_pipeline.rs` (新規/更新)
    - `jv/crates/jv_type_inference/src/lib.rs`
    - `jv/crates/jv_parser/src/lambda.rs`
  - コレクションに対する`map`/`filter`/`flatMap`等の連鎖呼び出しを検出し、`SequencePipeline`/`SequenceStage`/`SequenceTerminal` IRへ変換するビルダーを実装する。
  - タプル分解ラムダや空白区切り配列ソースをサポートし、型推論で遅延→即時遷移を判定する。
  - _Leverage: `SequenceStyleCache`, 既存`IrForEachKind::LazySequence`, `jv_type_inference`推論ユーティリティ_
  - _Requirements: Requirement 1, Requirement 3_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Compiler Engineer specializing in IR construction | Task: Implement implicit Sequence pipeline detection and IR generation according to Requirement 1 & 3, adding the new sequence_pipeline module and integrating with parser/type inference | Restrictions: Follow existing module boundaries, do not regress current array handling, ensure tuple destructuring lambdas are preserved | _Leverage: `SequenceStyleCache`, `IrForEachKind::LazySequence`, `jv_type_inference` utilities | _Requirements: Requirement 1, Requirement 3 | Success: Unit tests cover pipeline detection for map/filter/flatMap/take/drop/sorted, type inference toggles lazy/immediate correctly, tuple destructuring captured in IR | Instructions: Before starting set this task to [-] in tasks.md, set to [x] only after implementation and tests pass._

- [x] 2. `SequenceStage`/`SequenceTerminal` IR拡張と終端ポリシー実装
  - Files:
    - `jv/crates/jv_ir/src/sequence_pipeline.rs`
    - `jv/crates/jv_ir/src/lib.rs`
    - `jv/crates/jv_ir/tests/sequence_pipeline.rs`
  - `SequenceStage`と`SequenceTerminal` enumを詳細定義し、`reduce`空コレクション警告や`forEach`終端、`Count`/`Sum`の評価方針を実装する。
  - `SequenceSource`に配列ソースとJava Streamソースを追加し、flatten戦略を反映する。
  - _Leverage: 新規追加されたIRモデル、既存IR builderテストインフラ_
  - _Requirements: Requirement 1, Requirement 2, Requirement 3_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust IR Architect | Task: Finalize SequenceStage/SequenceTerminal data model with reduce/forEach semantics and array sources, adding coverage tests per Requirement 1-3 | Restrictions: Maintain backward compatibility for non-sequence IR, ensure diagnostics for empty reduce are emitted | _Leverage: IR builder test utilities, new sequence_pipeline module | _Requirements: Requirement 1, Requirement 2, Requirement 3 | Success: IR enums compile with exhaustive handling, tests verify stage/terminal serialization, empty reduce emits warning | Instructions: Mark task status appropriately before/after work._

- [x] 3. Javaコード生成とJava21フォールバック
  - Files:
    - `jv/crates/jv_codegen_java/src/generator/expressions.rs`
    - `jv/crates/jv_codegen_java/src/generator/statements.rs`
    - `jv/crates/jv_codegen_java/src/version.rs`
    - `jv/crates/jv_codegen_java/tests/sequence_streams.rs`
  - `SequenceTerminal`に基づき`Stream` API生成とforループ最適化を実装し、`toList`/`toSet`などのJava21フォールバックを切り替える。
  - `AutoCloseable`ソースの`try-with-resources`生成と`count`/`sum`最適化方針を実装する。
  - _Leverage: 既存`Stream`生成ユーティリティ、`IrForEachKind::LazySequence`コード_
  - _Requirements: Requirement 1, Requirement 2_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Java Codegen Specialist | Task: Implement Sequence terminal code generation with Java25/Java21 branching and resource guards per Requirement 1 & 2 | Restrictions: Generated Java must compile under both Java 25 and 21 targets, avoid duplicating existing for-each code, honor IllegalArgumentException policy for empty reduce | _Leverage: stream helper functions, version gating module | _Requirements: Requirement 1, Requirement 2 | Success: Codegen tests verify map/filter/take/drop pipelines, Java version switch outputs expected snippets, AutoCloseable guard generated, Java 25/21両ターゲットで`mvn compile`が成功して生成コードの構文が検証される, `toList`/`toSet`/`groupBy`/`associate`の4パターンで実行時結果が一致する | Instructions: Update task status before and after coding/testing._

- [x] 4. 標準ライブラリSequence拡張関数実装
  - Files:
    - `jv/stdlib/collections/sequence.jv` (新規)
    - `jv/stdlib/collections/tests/sequence_spec.jv`
  - `map`/`filter`/`flatMap`/`reduce`/`fold`/`associate`/`groupBy`/`sorted`/`sortedBy`/`take`/`drop`/`toList`/`toSet`/`count`/`sum`/`forEach`拡張関数を定義し、遅延チェーンを標準APIとして提供する。
  - 実装ステップを以下のフェーズに分割し、段階的に導入する。
    - [x] 4-1. **Phase 1 (基本変換)**: `map`, `filter`, `toList`
    - [x] 4-2. **Phase 2 (範囲操作)**: `take`, `drop`, `flatMap`
    - [x] 4-3. **Phase 3 (集約操作)**: `fold`, `reduce`, `count`, `sum`
    - [x] 4-4. **Phase 4 (ソート/グループ)**: `sorted`, `sortedBy`, `groupBy`, `associate`
    - [x] 4-5. **Phase 5 (副作用)**: `forEach`
  - Kotlinパリティ表に合致するドキュメントコメントを記述し、空集合`reduce`のエラーメッセージを整備する。
  - _Leverage: 既存`stdlib/collections`ヘルパ、数値・配列API_
  - _Requirements: Requirement 1, Requirement 2_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Stdlib Engineer | Task: Implement Kotlin-style Sequence extensions in stdlib per Requirement 1 & 2 with documentation and tests | Restrictions: Maintain zero-runtime-overhead contract, reuse existing helpers where possible, ensure lambdas require explicit params | _Leverage: collections helpers, doc comment templates | _Requirements: Requirement 1, Requirement 2 | Success: stdlib builds, doctests/sequence tests pass, docs show Kotlin parity notes, Phase 1〜5の順序でAPIが段階的に追加され各フェーズでテストが整備される | Instructions: Adjust task checkbox status when starting/completing._

- [x] 5. LSP/CLIヒントとドキュメント更新
  - Files:
    - `jv/crates/jv_lsp/src/features/documentation.rs`
    - `jv/crates/jv_cli/src/sequence_warnings.rs`
    - `docs/language-guide.md`
    - `docs/java-interop.md`
  - LSP補完に暗黙Sequence説明を追加し、ラムダ引数未指定エラー診断を実装する。
  - LSP/CLIで実装すべき機能:
    - [x] 5-1. Completion: `collection.` 入力時に暗黙Sequence操作を提示
    - [x] 5-2. Hover: `map`ホバー時にJava出力例を表示
    - [x] 5-3. Diagnostics: 変数宣言のない `{ it... }` などの検出時にE1001エラーを発行
    - [x] 5-4. CodeAction: `{ it -> x }` → `{ x -> x }` の自動修正提案
  - CLIヒントと公式ドキュメントに`asSequence()`不要方針、Java出力例、Java21フォールバック差異を追記する。
  - _Leverage: 既存LSPドキュメントAPI、CLI warning collector、言語ガイド構成_
  - _Requirements: Requirement 3_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Developer Experience Engineer | Task: Update LSP/CLI hints and documentation with implicit sequence guidance per Requirement 3 | Restrictions: Keep localized messaging structure, do not regress existing diagnostics, ensure docs remain bilingual-ready | _Leverage: documentation helpers, existing hint format | _Requirements: Requirement 3 | Success: LSP hover/completion shows new markdown, CLI emits explicit param error, docs include parity table updates, Completion/Hover/Diagnostics/CodeActionの各チェック項目が満たされる | Instructions: Update checkbox status accordingly._

- [x] 6. シーケンス補間終端処理自動化
  - Files:
    - `jv/crates/jv_ir/src/transform/strings.rs`
    - `jv/crates/jv_ir/src/types.rs`
    - `jv/crates/jv_ir/src/lib.rs`
    - `jv/crates/jv_codegen_java/src/generator/expressions.rs`
    - `jv/tests/lang/strings/sequence_interpolation.jv`
  - 文字列補間（`"${expr}"`）を`StringFormat` IRへ変換する際、補間対象の`JavaType`を参照して`Sequence<T>`であれば終端操作を強制する仕組みを追加する。
  - `Sequence`判定時には`IrExpression::SequencePipeline`へ`SequenceTerminalKind::ToList`を注入する、または`sequenceExpr.toList()`相当のIRノードを挿入して`String.valueOf`が遅延パイプラインを直接呼ばないようにする。
  - `generate_sequence_pipeline_expression`側で終端付きパイプラインが確実に即時評価され、Javaコードで`stream().toList()`等が出力されることを確認する。UnsupportedConstructが再発しないよう回帰テストを追加する。
  - _Leverage: lower_string_interpolation変換、SequencePipeline builder、Javaコード生成テスト_
  - _Requirements: Requirement 1, Requirement 2, Requirement 3_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: IR Transformation Specialist | Task: Detect sequences inside string interpolation and inject terminal operations per Requirements 1-3 | Restrictions: Avoid global Sequence::toString overrides, reuse existing IR helpers, preserve Java21/25フォールバック分岐 | _Leverage: lower_string_interpolation pass, sequence pipeline utilities | _Requirements: Requirement 1, Requirement 2, Requirement 3 | Success: IR dumps show ToList terminal insertion, string interpolation with sequences compiles to eager Java List, new lang test validates runtime output | Instructions: Toggle task status before/after work._

- [x] 7. リストリテラル下位変換対応
  - Files:
    - `jv/crates/jv_ast/src/expression.rs`
    - `jv/crates/jv_ir/src/sequence_pipeline.rs`
    - `jv/crates/jv_codegen_java/src/generator/expressions.rs`
    - `jv/crates/jv_codegen_java/tests/sequence_streams.rs`
    - `jv/tests/lang/collections/list_literal_sequences.jv`
  - 空白区切りリストリテラル`[1 2 3]`をIRで`SequenceSource::List`等へ下位変換し、Java生成時に`java.util.List.of(...)`（Java25）/`Collectors.toList()`等を介して具象`List`を生成するパスを追加する。
  - `listOf`ヘルパーや既存Sequence初期化ロジックを再利用し、生成コードで`null`初期化が残らないようにIRとコード生成を整備する。リストリテラル経由の`map`/`filter`チェーンの回帰テストを追加する。
  - _Leverage: SequencePipeline builder, java.codegen List helpers, langテストランナー_
  - _Requirements: Requirement 1, Requirement 2, Requirement 3_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: IR & Codegen Integration Engineer | Task: Lower whitespace list literals to concrete Java List construction across AST→IR→codegen per Requirements 1-3 | Restrictions: Follow existing module boundaries, honor Java21フォールバック, reuse list helper traits instead of ad-hoc builders | _Leverage: IR builder, codegen list utilities, lang test harness | _Requirements: Requirement 1, Requirement 2, Requirement 3 | Success: IR debug dumps show concrete List sources, codegen snapshots emit `List.of` or collector variants without `null`, new lang test passes under Java25/21 targets | Instructions: Manage task checkbox status during implementation._

- [x] 8. テストスイート拡充
  - Files:
    - `jv/crates/jv_ir/tests/sequence_pipeline.rs`
    - `jv/crates/jv_codegen_java/tests/sequence_streams.rs`
    - `jv/tests/lang/collections/sequence_chain.jv`
    - `jv/tests/lang/collections/java21_compat.jv`
  - IRユニットテスト、コード生成スナップショット、実行時統合テストを追加し、`numbers.map { x -> x * 2 }.filter { y -> y % 2 == 0 }.toList()`などのサンプルを検証する。
  - Java25/21両ターゲットで`toList`/`toSet`の出力差を確認し、`count`/`sum`最適化の回帰テストを追加する。
  - 文字列補間でSequenceを扱うLangテスト（例: `strings/sequence_interpolation.jv`）とIR/Codegenスナップショットを追加し、補間時の自動終端挿入とリスト具現化パスを回帰確認する。
  - _Leverage: 既存IR/Codegenテストインフラ、langテストランナー_
  - _Requirements: Requirement 1, Requirement 2, Requirement 3_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Tester with compiler expertise | Task: Build comprehensive tests for sequence pipeline, codegen, runtime across Java25/21 targets per Requirements 1-3 | Restrictions: Keep tests deterministic, reuse shared fixtures, ensure failing scenarios for empty reduce included | _Leverage: test harness macros, lang runner scripts | _Requirements: Requirement 1, Requirement 2, Requirement 3 | Success: New tests pass in CI, failures captured for regressions, coverage reports include new scenarios | Instructions: Manage task status toggles during execution._

- [x] 9. リリースノートと標準ライブラリドキュメント更新
  - Files:
    - `docs/stdlib/collections.md`
    - `CHANGELOG.md` / `docs/releases/v0.1-alpha.md`
    - `jv/crates/jv_cli/src/help.rs`
  - KotlinスタイルコレクションAPI導入に伴うドキュメント、CLIヘルプ、リリースノートを更新し、JavaStreamブリッジ方針と制限事項を明記する。
  - _Leverage: 既存ドキュメントテンプレート、CLIヘルプシステム_
  - _Requirements: Requirement 2, Requirement 3_
  - _Prompt: Implement the task for spec kotlin-style-collection-sequence, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer with developer tooling focus | Task: Update docs/help/release notes reflecting Kotlin-style collection API per Requirements 2 & 3 | Restrictions: Maintain documentation tone, include parity table and explicit lambda guidance, avoid duplicating content | _Leverage: existing doc templates, CLI help formatting | _Requirements: Requirement 2, Requirement 3 | Success: Docs merged without lint errors, CLI help shows new commands, release notes list feature with Stream output notes | Instructions: Adjust task checkbox status when progressing._
